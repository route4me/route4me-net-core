name: AI Code Risk & Compatibility Analysis (Gemini)

on:
  pull_request:
    branches:
      - master
      - main

jobs:
  gemini-analysis:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout PR code
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Get changed C# files from diff
      - name: Get changed files
        id: changed
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "Base branch: $BASE_BRANCH"
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"
          
          # Fetch the base branch explicitly to ensure it's available
          git fetch origin "$BASE_BRANCH" || true
          
          # Get changed C# files comparing base SHA to head SHA
          # Fallback to branch comparison if SHA comparison fails
          CHANGED_FILES=$(git diff --name-only "$BASE_SHA"..."$HEAD_SHA" 2>/dev/null | grep '\.cs$' || \
                         git diff --name-only "origin/$BASE_BRANCH"...HEAD 2>/dev/null | grep '\.cs$' || \
                         git diff --name-only "$BASE_BRANCH"...HEAD 2>/dev/null | grep '\.cs$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No C# files changed in this PR"
            echo "changed_files=" >> $GITHUB_OUTPUT
          else
            echo "Changed C# files:"
            echo "$CHANGED_FILES"
            # Convert newlines to spaces for GitHub Actions output (multiline values cause issues)
            CHANGED_FILES_SPACE=$(echo "$CHANGED_FILES" | tr '\n' ' ' | xargs)
            echo "changed_files=$CHANGED_FILES_SPACE" >> $GITHUB_OUTPUT
          fi

      # 3. Install Gemini CLI
      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      # 4. Run Gemini AI
      - name: Run Gemini Analysis
        id: gemini
        if: steps.changed.outputs.changed_files != ''
        run: |
          # Convert space-separated files back to proper format
          CHANGED_FILES="${{ steps.changed.outputs.changed_files }}"
          
          # Filter only existing files (exclude deleted files)
          EXISTING_FILES=""
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              EXISTING_FILES="$EXISTING_FILES $file"
              echo "  [OK] $file exists"
            else
              echo "  [SKIP] $file NOT FOUND (likely deleted)"
            fi
          done
          
          # Trim leading/trailing spaces
          EXISTING_FILES=$(echo "$EXISTING_FILES" | xargs)
          
          if [ -z "$EXISTING_FILES" ]; then
            echo "No existing files to analyze"
            echo "output_file=" >> $GITHUB_OUTPUT
            echo "exit_code=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Running Gemini analysis on: $EXISTING_FILES"
          
          # Run Gemini CLI
          set +e
          gemini run \
            --api-key "${{ secrets.GEMINI_API_KEY }}" \
            --files "$EXISTING_FILES" \
            --task "Analyze these changed C# files for: Security and performance risks, Deprecated API usage, Coding standard violations, Potential backward compatibility risks (API signature changes, Data contract changes, Removal/renaming of public members, Behavior changes affecting clients). Provide severity (Low/Medium/High) and improvement suggestions." \
            > gemini_output.txt 2>&1
          GEMINI_EXIT_CODE=$?
          set -e
          
          echo "Gemini CLI exit code: $GEMINI_EXIT_CODE"
          
          if [ $GEMINI_EXIT_CODE -ne 0 ]; then
            echo "WARNING: Gemini CLI failed"
            echo "" >> gemini_output.txt
            echo "--- Error Details ---" >> gemini_output.txt
            echo "Exit code: $GEMINI_EXIT_CODE" >> gemini_output.txt
            echo "Command: gemini run --files \"$EXISTING_FILES\"" >> gemini_output.txt
          fi
          
          echo "output_file=gemini_output.txt" >> $GITHUB_OUTPUT
          echo "exit_code=$GEMINI_EXIT_CODE" >> $GITHUB_OUTPUT

      # 5. Post results to PR comment
      - name: Comment on PR with Gemini Findings
        if: steps.changed.outputs.changed_files != '' && steps.gemini.outputs.output_file != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const outputFile = '${{ steps.gemini.outputs.output_file }}';
            const exitCode = '${{ steps.gemini.outputs.exit_code }}';
            
            let analysisOutput = '';
            let statusIcon = '[OK]';
            let statusText = 'Analysis completed successfully';
            
            if (fs.existsSync(outputFile)) {
              analysisOutput = fs.readFileSync(outputFile, 'utf8');
              if (!analysisOutput.trim()) {
                analysisOutput = 'No analysis output was generated.';
                statusIcon = '[WARNING]';
                statusText = 'No output generated';
              } else if (exitCode && exitCode !== '0') {
                statusIcon = '[ERROR]';
                statusText = `Analysis failed with exit code ${exitCode}`;
              }
            } else {
              analysisOutput = 'Analysis output file was not found.';
              statusIcon = '[ERROR]';
              statusText = 'Output file not found';
            }
            
            const body = `## Gemini AI Code Risk & Compatibility Analysis
            
            **Status:** ${statusIcon} ${statusText}
            
            **Files analyzed:** \`${{ steps.changed.outputs.changed_files }}\`
            
            ### Analysis Results
            
            \`\`\`
            ${analysisOutput}
            \`\`\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });